# name: test/sql/raster.test
# description: Test raster functions with sample data
# group: [raquet]

require raquet

# =============================================================================
# Test raquet_pixel function
# =============================================================================

# Test basic pixel extraction with manually created test data
# Create a simple 4x4 uint8 tile (uncompressed)
statement ok
CREATE TABLE test_tile AS
SELECT
    5234261499580514304::UBIGINT as block,
    -- 4x4 grid with values 1-16
    '\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10'::BLOB as band_1

# Test pixel at (0,0) - should be 1
query I
SELECT raquet_pixel(band_1, 'uint8', 0, 0, 4, 'none') FROM test_tile
----
1.0

# Test pixel at (1,0) - should be 2
query I
SELECT raquet_pixel(band_1, 'uint8', 1, 0, 4, 'none') FROM test_tile
----
2.0

# Test pixel at (3,3) - should be 16
query I
SELECT raquet_pixel(band_1, 'uint8', 3, 3, 4, 'none') FROM test_tile
----
16.0

# Test pixel at (2,1) - row 1, col 2 = 1*4+2+1 = 7
query I
SELECT raquet_pixel(band_1, 'uint8', 2, 1, 4, 'none') FROM test_tile
----
7.0

statement ok
DROP TABLE test_tile

# =============================================================================
# Test with different data types
# =============================================================================

# Test int16 data type
statement ok
CREATE TABLE test_int16 AS
SELECT
    1::UBIGINT as block,
    -- 2x2 grid: [100, 200, -100, -200] as int16 (little-endian)
    '\x64\x00\xC8\x00\x9C\xFF\x38\xFF'::BLOB as band_1

query I
SELECT raquet_pixel(band_1, 'int16', 0, 0, 2, 'none') FROM test_int16
----
100.0

query I
SELECT raquet_pixel(band_1, 'int16', 1, 0, 2, 'none') FROM test_int16
----
200.0

query I
SELECT raquet_pixel(band_1, 'int16', 0, 1, 2, 'none') FROM test_int16
----
-100.0

query I
SELECT raquet_pixel(band_1, 'int16', 1, 1, 2, 'none') FROM test_int16
----
-200.0

statement ok
DROP TABLE test_int16

# =============================================================================
# Test float32 data type
# =============================================================================

statement ok
CREATE TABLE test_float32 AS
SELECT
    1::UBIGINT as block,
    -- Single float32 value: 3.14159
    '\xD0\x0F\x49\x40'::BLOB as band_1

query I
SELECT round(raquet_pixel(band_1, 'float32', 0, 0, 1, 'none'), 4) FROM test_float32
----
3.1416

statement ok
DROP TABLE test_float32

# =============================================================================
# Test raquet_decode_band
# =============================================================================

statement ok
CREATE TABLE test_decode AS
SELECT
    1::UBIGINT as block,
    '\x01\x02\x03\x04'::BLOB as band_1

query I
SELECT length(raquet_decode_band(band_1, 'uint8', 2, 2, 'none')) FROM test_decode
----
4

statement ok
DROP TABLE test_decode

# =============================================================================
# Test ST_RasterSummaryStats structure
# =============================================================================

statement ok
CREATE TABLE test_stats AS
SELECT
    1::UBIGINT as block,
    -- 4 uint8 values: 10, 20, 30, 40
    '\x0A\x14\x1E\x28'::BLOB as band_1

query IIIIII
SELECT
    (ST_RasterSummaryStats(band_1, 'uint8', 2, 2, 'none')).count,
    (ST_RasterSummaryStats(band_1, 'uint8', 2, 2, 'none')).sum,
    (ST_RasterSummaryStats(band_1, 'uint8', 2, 2, 'none')).mean,
    (ST_RasterSummaryStats(band_1, 'uint8', 2, 2, 'none')).min,
    (ST_RasterSummaryStats(band_1, 'uint8', 2, 2, 'none')).max,
    round((ST_RasterSummaryStats(band_1, 'uint8', 2, 2, 'none')).stddev, 4)
FROM test_stats
----
4	100.0	25.0	10.0	40.0	12.9099

statement ok
DROP TABLE test_stats

# =============================================================================
# Test metadata-aware ST_RasterSummaryStats
# =============================================================================

statement ok
CREATE TABLE test_stats_meta AS
SELECT
    1::UBIGINT as block,
    '\x0A\x14\x1E\x28'::BLOB as band_1,
    '{"file_format":"raquet","compression":"none","tiling":{"block_width":2,"block_height":2},"bands":[{"name":"band_1","type":"uint8"}]}'::VARCHAR as metadata

# ST_RasterSummaryStats(band, metadata) should give same results as explicit version
query IIIIII
SELECT
    (ST_RasterSummaryStats(band_1, metadata)).count,
    (ST_RasterSummaryStats(band_1, metadata)).sum,
    (ST_RasterSummaryStats(band_1, metadata)).mean,
    (ST_RasterSummaryStats(band_1, metadata)).min,
    (ST_RasterSummaryStats(band_1, metadata)).max,
    round((ST_RasterSummaryStats(band_1, metadata)).stddev, 4)
FROM test_stats_meta
----
4	100.0	25.0	10.0	40.0	12.9099

# ST_RasterSummaryStats(band, metadata, band_index) should also work
query I
SELECT (ST_RasterSummaryStats(band_1, metadata, 0)).count FROM test_stats_meta
----
4

statement ok
DROP TABLE test_stats_meta

# =============================================================================
# Test null handling
# =============================================================================

query I
SELECT raquet_pixel(NULL, 'uint8', 0, 0, 4, 'none')
----
NULL

# =============================================================================
# Test ST_RegionStats resolution parameter
# =============================================================================

# Create test tiles at different resolutions
statement ok
CREATE TABLE test_resolution AS
SELECT * FROM (VALUES
    -- Resolution 5 tile (z=5)
    (quadbin_from_tile(15, 10, 5), '\x0A\x14\x1E\x28'::BLOB),
    -- Resolution 6 tile (z=6)
    (quadbin_from_tile(30, 20, 6), '\x0B\x15\x1F\x29'::BLOB),
    -- Resolution 7 tile (z=7)
    (quadbin_from_tile(60, 40, 7), '\x0C\x16\x20\x2A'::BLOB)
) AS t(block, band_1)

# Create metadata with resolution info
statement ok
CREATE TABLE test_meta AS
SELECT '{"compression":"none","block_width":2,"block_height":2,"minresolution":5,"maxresolution":7,"bands":[["band_1","uint8"]]}'::VARCHAR as metadata

# Verify tiles are at different resolutions
query II
SELECT quadbin_resolution(block) as res, block FROM test_resolution ORDER BY res
----
5	5211641135193128959
6	5216141436285616127
7	5220644211279265791

statement ok
DROP TABLE test_resolution

statement ok
DROP TABLE test_meta

# =============================================================================
# Test bounds checking - out-of-range pixel coordinates
# =============================================================================

# Create a small 2x2 tile for bounds testing
statement ok
CREATE TABLE test_bounds AS
SELECT
    1::UBIGINT as block,
    '\x0A\x14\x1E\x28'::BLOB as band_1

# Out-of-range x (999 on a width=2 tile) - returns NULL via buffer bounds check
query I
SELECT raquet_pixel(band_1, 'uint8', 999, 0, 2, 'none') FROM test_bounds
----
NULL

# Out-of-range y (999 on a width=2 tile) - returns NULL via buffer bounds check
query I
SELECT raquet_pixel(band_1, 'uint8', 0, 999, 2, 'none') FROM test_bounds
----
NULL

# Negative coordinates - returns NULL
query I
SELECT raquet_pixel(band_1, 'uint8', -1, 0, 2, 'none') FROM test_bounds
----
NULL

# Valid coordinates still work
query I
SELECT raquet_pixel(band_1, 'uint8', 0, 0, 2, 'none') FROM test_bounds
----
10.0

# Metadata-aware pixel with out-of-range coords - returns NULL
statement ok
CREATE TABLE test_bounds_meta AS
SELECT
    1::UBIGINT as block,
    '\x0A\x14\x1E\x28'::BLOB as band_1,
    '{"file_format":"raquet","compression":"none","tiling":{"block_width":2,"block_height":2},"bands":[{"name":"band_1","type":"uint8"}]}'::VARCHAR as metadata

query I
SELECT raquet_pixel(band_1, metadata, 999, 999) FROM test_bounds_meta
----
NULL

# Valid metadata-aware access still works
query I
SELECT raquet_pixel(band_1, metadata, 1, 1) FROM test_bounds_meta
----
40.0

statement ok
DROP TABLE test_bounds

statement ok
DROP TABLE test_bounds_meta

# =============================================================================
# Test truncated blob handling
# =============================================================================

# Truncated blob: only 2 bytes but claiming 4x4 uint8 tile (needs 16 bytes) - returns NULL
query I
SELECT raquet_decode_band('\x0A\x14'::BLOB, 'uint8', 4, 4, 'none')
----
NULL

# Empty blob returns NULL
query I
SELECT raquet_pixel(NULL, 'uint8', 0, 0, 4, 'none')
----
NULL

# =============================================================================
# Test NaN nodata handling in ST_RasterSummaryStats
# =============================================================================

# Create a tile with a NaN value (float32)
# float32 NaN = 0x7FC00000 (little-endian: \x00\x00\xC0\x7F)
# float32 1.0 = 0x3F800000 (little-endian: \x00\x00\x80\x3F)
# float32 2.0 = 0x40000000 (little-endian: \x00\x00\x00\x40)
# float32 3.0 = 0x40400000 (little-endian: \x00\x00\x40\x40)
statement ok
CREATE TABLE test_nan_nodata AS
SELECT
    1::UBIGINT as block,
    '\x00\x00\x80\x3F\x00\x00\x00\x40\x00\x00\x40\x40\x00\x00\xC0\x7F'::BLOB as band_1

# Without nodata filtering: count should be 4 (including NaN)
query I
SELECT (ST_RasterSummaryStats(band_1, 'float32', 2, 2, 'none')).count FROM test_nan_nodata
----
4

# With NaN as nodata: count should be 3 (NaN filtered out)
query I
SELECT (ST_RasterSummaryStats(band_1, 'float32', 2, 2, 'none', 'NaN'::DOUBLE)).count FROM test_nan_nodata
----
3

# With NaN as nodata: sum should be 6.0 (1+2+3)
query I
SELECT (ST_RasterSummaryStats(band_1, 'float32', 2, 2, 'none', 'NaN'::DOUBLE)).sum FROM test_nan_nodata
----
6.0

# Without nodata arg (5-arg version, no filtering): count should be 4
query I
SELECT (ST_RasterSummaryStats(band_1, 'float32', 2, 2, 'none')).count FROM test_nan_nodata
----
4

statement ok
DROP TABLE test_nan_nodata

# =============================================================================
# Note: ST_RasterValue and spatial predicate functions use
# DuckDB 1.5+ native GEOMETRY types. Create geometries using WKT cast:
#   'POINT(-3.7 40.4)'::GEOMETRY
# =============================================================================
